# How Salesloft AI Transcript Extraction Works

## Overview

This script fetches **AI-generated conversation transcripts** from Salesloft API calls. These are word-for-word transcriptions of phone conversations, automatically generated by Salesloft's speech-to-text AI.

---

## The 3-Step API Process

### Step 1: Get Call Records
**Endpoint:** `GET /v2/call_data_records.json`

This returns basic call information.

**Request:**
```javascript
GET https://api.salesloft.com/v2/call_data_records.json?has_recording=true&per_page=10
```

**Response Schema:**
```json
{
  "data": [
    {
      "id": 474853370,
      "call_uuid": "092ae85c-b876-442f-a293-10c54de51ae5",
      "status": "completed",
      "duration": 98,
      "from": "+16024973078",
      "to": "+14806354050",
      "recording": {
        "status": "completed",
        "url": "https://recordings.salesloft.com/c/119363/..."
      },
      "call": {
        "id": 100913569
      }
    }
  ]
}
```

**Key Fields:**
- `id` - Call Data Record ID
- `call_uuid` - Unique identifier for the call
- `call.id` - Activity call ID (needed for Step 2)
- `duration` - Call length in seconds
- `status` - "completed", "failed", "voicemail", etc.

---

### Step 2: Get Conversation with Transcription ID
**Endpoint:** `GET /v2/conversations.json`

This links the call to its conversation and transcription.

**Request:**
```javascript
GET https://api.salesloft.com/v2/conversations.json?call_data_record_id=474853370
```

**Response Schema:**
```json
{
  "data": [
    {
      "id": "fcc89fd4-e795-4027-9792-8cfabcc0933a",
      "transcription_id": "3b4297df-76ec-41f3-adc6-4e7cbf66a0e2",
      "call_data_record_id": 474853370,
      "status": "completed"
    }
  ]
}
```

**Key Field:**
- `transcription_id` - This is what we need! It tells us an AI transcript exists.

**IMPORTANT:** If `transcription_id` is **missing or null**, there is **NO AI transcript** for this call.

---

### Step 3: Get AI Transcript Sentences
**Endpoint:** `GET /v2/transcriptions/{transcription_id}/sentences.json`

This returns the actual conversation text, sentence by sentence.

**Request:**
```javascript
GET https://api.salesloft.com/v2/transcriptions/3b4297df-76ec-41f3-adc6-4e7cbf66a0e2/sentences.json?per_page=100&page=1
```

**⚠️ IMPORTANT: Pagination Required!**

Long conversations may have more than 100 sentences. The API returns a maximum of 100 sentences per page, so you MUST handle pagination to get the complete transcript.

**Response Schema:**
```json
{
  "data": [
    {
      "id": "sent-001",
      "order_number": 1,
      "text": "Hi, this is John calling from Acme Corp.",
      "start_time": 0.5,
      "end_time": 3.2,
      "recording_attendee_id": "attendee-001"
    },
    {
      "id": "sent-002",
      "order_number": 2,
      "text": "How are you doing today?",
      "start_time": 3.3,
      "end_time": 4.8,
      "recording_attendee_id": "attendee-001"
    },
    {
      "id": "sent-003",
      "order_number": 3,
      "text": "I'm good, thanks for calling.",
      "start_time": 5.0,
      "end_time": 6.5,
      "recording_attendee_id": "attendee-002"
    }
  ]
}
```

**Key Fields:**
- `text` - The actual spoken words (THIS IS THE AI TRANSCRIPT!)
- `order_number` - Sentence order in the conversation
- `start_time` / `end_time` - Timestamps in the recording
- `recording_attendee_id` - Who said it (seller vs prospect)

**Pagination Metadata:**
```json
{
  "metadata": {
    "paging": {
      "current_page": 1,
      "next_page": 2,
      "per_page": 100,
      "total_count": 237
    }
  }
}
```

**Handling Pagination:**
```javascript
let allSentences = [];
let currentPage = 1;

do {
  const response = await fetchSentences(transcriptionId, currentPage);
  allSentences = allSentences.concat(response.data);

  // Check if there are more pages
  const paging = response.metadata?.paging;
  if (!paging?.next_page) break;

  currentPage++;
} while (true);
```

**Final Transcript:**
We combine all `text` fields in `order_number` order to create the full conversation:

```
"Hi, this is John calling from Acme Corp. How are you doing today? I'm good, thanks for calling..."
```

---

## How We Ensure AI Transcripts Only

### ✅ What Qualifies as an AI Transcript:

1. **Must have a `transcription_id`** in Step 2
2. **Must return sentences** in Step 3 (`data.length > 0`)
3. **Auto-generated by AI** - Not typed by humans

### ❌ What We Filter Out:

#### Manual Notes (Not AI):
**Endpoint:** `GET /v2/notes/{note_id}.json`

```json
{
  "data": {
    "id": 62894378,
    "content": "Rogelio doesn't work there anymore. Will try to find a new contact.",
    "created_at": "2025-11-12T20:00:00Z"
  }
}
```

**Why it's filtered:**
- Manually typed by the sales rep AFTER the call
- Short summary, not word-for-word conversation
- Source: Notes API, not Transcriptions API

#### Failed/No-Answer Calls:
```json
{
  "status": "failed",  // or "voicemail", "no-answer"
  "duration": null,
  "recording": {
    "status": "not_recorded"
  }
}
```

**Why it's filtered:**
- No conversation happened
- No recording exists
- `transcription_id` will be null

---

## Detection Logic in Code

```javascript
// Step 1: Fetch call data
const callRecords = await fetchTranscripts();

// Step 2: For each call, try to get conversation
for (const record of callRecords) {
  const conversationData = await listConversations(record.id);

  // CHECK: Does it have a transcription_id?
  if (conversationData.data[0].transcription_id) {
    // ✅ AI TRANSCRIPT EXISTS

    // Step 3: Fetch the actual transcript sentences
    const sentences = await fetchTranscriptionSentences(
      conversationData.data[0].transcription_id
    );

    if (sentences.data.length > 0) {
      // ✅ CONFIRMED: We have AI transcript text!
      const transcript = sentences.data
        .sort((a, b) => a.order_number - b.order_number)
        .map(s => s.text)
        .join(' ');

      // Save this as AI transcript
    }
  } else {
    // ❌ NO AI TRANSCRIPT
    // Skip or try manual notes fallback
  }
}
```

---

## Console Output Indicators

The script shows clear indicators:

### ✅ AI Transcript Found:
```
[AI TRANSCRIPT] Trying to fetch conversation...
[AI TRANSCRIPT] Found conversation ID: fcc89fd4-e795-4027-9792-8cfabcc0933a
[AI TRANSCRIPT] Fetching transcription sentences (ID: 3b4297df-76ec-41f3-adc6-4e7cbf66a0e2)...
✅ [AI TRANSCRIPT] Found 51 AI-generated transcript sentences!
✓ Saved locally: transcript_call_474853370_xxx.txt (✅ AI TRANSCRIPT)
```

### ⚠️ Manual Note Only:
```
Note is an object with fields: [ '_href', 'id' ]
[MANUAL NOTE] Fetching note content from API (ID: 62894378)...
⚠️  [MANUAL NOTE] Found manual note (not AI transcript)
✓ Saved locally: transcript_call_474839497_xxx.txt (⚠️  MANUAL NOTE ONLY)
```

### ❌ Nothing Found:
```
[AI TRANSCRIPT] Conversation found but no transcription_id available
✓ Saved locally: transcript_call_474843137_xxx.txt (no transcript found)
```

---

## Summary

**AI Transcripts:**
- 3 API calls: Call Data → Conversation → Sentences
- Requires `transcription_id` to exist
- Returns sentence-by-sentence spoken dialogue
- Auto-generated by Salesloft's AI

**Manual Notes:**
- 1 API call: Notes
- Short typed summaries
- Written by sales reps after calls
- NOT the actual conversation

**To get AI transcripts only:** We check for `transcription_id` existence before proceeding to fetch sentences. If missing, we skip the call.

---

## Scaling and Performance Optimizations

### Smart Filtering

To efficiently process large volumes of calls, we apply filters BEFORE attempting to fetch transcripts:

1. **Status Filter**: Only process `status: "completed"` calls
   - Skips: "failed", "voicemail", "no-answer", "routed"

2. **Duration Filter**: Only process calls >= 30 seconds
   - Short calls rarely have meaningful AI transcripts

3. **Call Activity Filter**: Only process calls with `call.id`
   - Required to fetch conversation data

### Early Transcription Check

Instead of fetching full call data for every record, we:

1. Fetch the conversation: `GET /v2/conversations.json?call_data_record_id=X`
2. Check if `transcription_id` exists
3. If null, **skip immediately** (saves 2 API calls)
4. If present, proceed to fetch sentences

This reduces API calls by ~80% when processing large batches.

### Pagination Handling

**Call Data Records Pagination:**
```javascript
// Fetch up to 100 records across multiple pages
let allRecords = [];
let page = 1;

while (allRecords.length < maxRecords) {
  const response = await fetchCallDataRecords(page);
  allRecords = allRecords.concat(response.data);

  if (!response.metadata.paging.next_page) break;
  page++;
}
```

**Sentence Pagination:**
```javascript
// Fetch ALL sentences for a single transcript
let allSentences = [];
let page = 1;

do {
  const response = await fetchSentences(transcriptionId, page);
  allSentences = allSentences.concat(response.data);

  const totalPages = Math.ceil(
    response.metadata.paging.total_count /
    response.metadata.paging.per_page
  );

  if (page >= totalPages) break;
  page++;
} while (true);
```

### Configuration

Adjust these values in `index.js` to scale:

```javascript
const MAX_RECORDS_TO_FETCH = 100;  // How many call records to fetch
const MIN_DURATION = 30;            // Minimum call duration (seconds)
```

### Expected Results

With smart filtering on ~100 call records:
- **Fetched**: 100 calls
- **Passed filters**: ~40-50 calls (40-50%)
- **Have AI transcripts**: ~5-10 calls (5-10%)
- **Skipped early**: ~30-40 calls (saved ~90-120 API calls)
- **Final transcripts**: 5-10 complete AI transcripts saved
